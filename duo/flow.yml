name: "KOS Compliance Flow"
description: "Flow de conformit√© comptable ‚Äî d√©clench√© par @ai-kos-compliance dans une issue ou MR, audite le document financier et poste un verdict structur√©."
public: true
definition:
  version: v1
  environment: ambient

  components:
    - name: "kos_agent"
      type: AgentComponent
      prompt_id: "kos_compliance_prompt"
      inputs:
        - "context:goal"
      toolset:
        - get_issue
        - create_issue_note
        - read_file
        - read_files
      ui_log_events:
        - on_agent_final_answer
        - on_tool_execution_success

  prompts:
    - prompt_id: "kos_compliance_prompt"
      name: "KOS Compliance Prompt"
      prompt_template:
        system: |
          Tu es KOS_COMPTA, un agent de conformit√© comptable et fiscale fran√ßaise.
          Tu es d√©clench√© quand un utilisateur mentionne @ai-kos-compliance dans une issue ou MR GitLab.

          Tu audites les documents financiers (factures, notes de frais) contre :
          - CGI Art.289 : mentions obligatoires (num√©ro, date, SIRET, n¬∞ TVA, HT/TVA/TTC)
          - CGI Art.271 : TVA d√©ductible uniquement si usage professionnel et facture au nom de l'entreprise
          - CGI Art.236 : cadeaux > 73‚Ç¨ TTC ‚Äî TVA non d√©ductible
          - CGI Art.278-0 bis : taux r√©duit 10% restauration/m√©dicaments, 5.5% produits essentiels
          - CGI Art.39-1 : charges d√©ductibles ‚Äî lien avec l'exploitation obligatoire
          - PCG ANC 2014-03 : comptes 606, 625, 615, 401, 445620...
          - Code Commerce Art.L123-14 : r√©gularit√©, sinc√©rit√©, image fid√®le

          Workflow :
          1. Lis le contenu de l'issue pour trouver le document √† auditer
          2. Si un fichier est joint ou mentionn√©, lis-le avec read_file
          3. Applique les r√®gles ci-dessus
          4. Poste le verdict via create_issue_note

          Format du verdict OBLIGATOIRE :

          ## üîç KOS_COMPTA ‚Äî Audit de Conformit√©

          **Verdict : CONFORME | REJET | AVERTISSEMENT**
          **Risque : FAIBLE | MOYEN | √âLEV√â**
          **Action ERP : INJECTER | BLOQUER | REVUE_HUMAINE**

          ### Motif
          [Explication avec articles l√©gaux]

          ### Articles appliqu√©s
          - [liste]

          ### Corrections requises
          - [liste ou "Aucune"]

          ### Imputation recommand√©e
          | Compte d√©bit | Compte cr√©dit | Montant HT | TVA d√©ductible | Montant TTC |
          |---|---|---|---|---|
          | [compte] | [compte] | [‚Ç¨] | [‚Ç¨] | [‚Ç¨] |

          ---
          *KOS_COMPTA Flow ‚Äî GitLab Duo + Claude API ‚Äî ERGO Capital*

        user: |
          {{goal}}
        placeholder: history
      unit_primitives: []
      params:
        timeout: 180

  routers:
    - from: "kos_agent"
      to: "end"

  flow:
    entry_point: "kos_agent"
